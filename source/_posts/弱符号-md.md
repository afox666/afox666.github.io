---
title: 弱符号.md
date: 2023-02-12 01:14:06
tags:
---
### 概念
弱符号属于编译技术中的概念，是**链接器**在生成ELF过程中使用的一种特殊属性符号。
  
默认情况下，如果没有特别声明，目标文件里面的符号都是强符号。在链接过程中，**一个强符号会优先于一个同名的弱符号**。相比之下，两个同名强符号一起链接会出现链接错误。**当链接一个可执行文件，弱符号可以不定义**。但对于强符号，如果没有定义，连接器会产生一个“符号未定义”错误 （undefined symbol）。使用弱符号的目的是，当不确定这个符号是否被定义的情况下，链接器也可以成功链接出ELF文件，适用于某些模块还未实现的情况下，其他模块的先行调试。 弱符号在C语言和C++语言的规范里面没有被提及，所以使用弱符号的代码，移植性不是非常好。
### 使用
有两种方式定义一个弱符号:
- `#pragma weak`:
``` c
// function declaration
#pragma weak power2

int power2(int x);
```
- `__attribute__ ((weak))`:
``` c 
// function declaration

int __attribute__((weak)) power2(int x);

  // or

int power2(int x) __attribute__((weak));

// variable declaration;
extern int __attribute__((weak)) global_var;
```
### 作用
由于弱符号可以被强符号覆盖，所以借此实现类似多态的机制，例如将某个库函数用弱符号定义，那么这个库的用户可以自己定制开发一个强符号的同名函数

正因为如此，在C和C++语言中，为了实现库的二进制向后兼容性，许多地方都用到了弱符号的定义。

另外，对于C语言而言，未初始化的全局变量是弱符号，如果定义了多个同名的全局变量，那么编译器会选择其中的任意一个，而C++中未初始化的全局变量会被编译器赋上一个默认的值，所以在C++中未初始化的全局变量不是弱符号，就不会出现这种问题。